name: Claude Bot

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-trigger:
    name: Check for Claude Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      request_text: ${{ steps.check.outputs.request_text }}
    steps:
      - name: Check for @claude mention
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue?.body || '';
            const commentBody = context.payload.comment?.body || '';
            const text = commentBody || issueBody;

            const hasClaude = text.toLowerCase().includes('@claude');
            const hasLabel = context.payload.issue?.labels?.some(l => l.name === 'claude-request');

            if (hasClaude || hasLabel) {
              core.setOutput('should_run', 'true');
              // Extract text after @claude
              const match = text.match(/@claude\s*([\s\S]*)/i);
              const requestText = match ? match[1].trim() : text;
              core.setOutput('request_text', requestText);
              console.log('Claude trigger detected');
            } else {
              core.setOutput('should_run', 'false');
              console.log('No Claude trigger found');
            }

  claude-respond:
    name: Claude Response
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install @anthropic-ai/sdk

      - name: Acknowledge Request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üëã Hi! I'm Claude, and I've received your request. I'm analyzing the codebase and will create a pull request with my proposed changes shortly.\n\n‚è≥ Processing...`
            });

      - name: Get Codebase Context
        id: context
        run: |
          # Get list of public cmdlets
          echo "Getting codebase structure..."
          find PSZoom/Public -name "*.ps1" | head -20 > /tmp/public_files.txt

          # Get sample cmdlet patterns
          echo "Sampling cmdlet patterns..."
          cat PSZoom/Public/Users/Get-ZoomUser.ps1 > /tmp/sample_cmdlet.txt 2>/dev/null || true
          cat PSZoom/Public/Meetings/Get-ZoomMeeting.ps1 >> /tmp/sample_cmdlet.txt 2>/dev/null || true

          # Get private helper functions
          cat PSZoom/Private/Get-ZoomPaginatedData.ps1 > /tmp/helpers.txt 2>/dev/null || true
          cat PSZoom/Private/Invoke-ZoomRestMethod.ps1 >> /tmp/helpers.txt 2>/dev/null || true

          echo "Context gathered"

      - name: Process with Claude
        id: claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REQUEST_TEXT: ${{ needs.check-trigger.outputs.request_text }}
        with:
          script: |
            const Anthropic = require('@anthropic-ai/sdk').default;
            const fs = require('fs');

            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY
            });

            const request = process.env.REQUEST_TEXT;
            const issueTitle = context.payload.issue?.title || 'Claude Request';
            const issueNumber = context.issue.number;

            // Read context files
            let sampleCmdlet = '';
            let helpers = '';
            try {
              sampleCmdlet = fs.readFileSync('/tmp/sample_cmdlet.txt', 'utf8');
              helpers = fs.readFileSync('/tmp/helpers.txt', 'utf8');
            } catch (e) {
              console.log('Could not read some context files');
            }

            const systemPrompt = `You are a PowerShell expert helping maintain the PSZoom module, a PowerShell wrapper for the Zoom REST API v2.

            IMPORTANT GUIDELINES:
            1. Follow existing code patterns exactly
            2. Use Verb-ZoomNoun naming convention for cmdlets
            3. Include comprehensive comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE, .LINK)
            4. Support pipeline input where appropriate
            5. Use parameter aliases that match Zoom API field names (e.g., meeting_id for MeetingId)
            6. Use Invoke-ZoomRestMethod for API calls
            7. Use Get-ZoomPaginatedData for paginated endpoints
            8. Include ValidateSet for enum parameters
            9. Include ValidateRange for numeric parameters
            10. Support -Full switch for detailed responses where applicable

            When responding, provide:
            1. A brief explanation of the changes
            2. The complete PowerShell code for any new or modified files
            3. Wrap code in markdown code blocks with the file path as a comment at the top

            Example format:
            \`\`\`powershell
            # PSZoom/Public/Category/Verb-ZoomNoun.ps1
            <#
            .SYNOPSIS
            ...
            #>
            function Verb-ZoomNoun {
                ...
            }
            \`\`\``;

            const userPrompt = `Issue #${issueNumber}: ${issueTitle}

            Request: ${request}

            Here are example cmdlet patterns from the codebase:
            ${sampleCmdlet.substring(0, 5000)}

            Here are helper functions:
            ${helpers.substring(0, 3000)}

            Please provide the implementation following the patterns shown above.`;

            try {
              const response = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                system: systemPrompt,
                messages: [{
                  role: 'user',
                  content: userPrompt
                }]
              });

              const responseText = response.content[0].text;
              core.setOutput('response', responseText);
              core.setOutput('success', 'true');

              // Extract code blocks and file paths
              const codeBlocks = responseText.match(/```powershell\n# ([^\n]+)\n([\s\S]*?)```/g) || [];
              core.setOutput('code_blocks', JSON.stringify(codeBlocks));

            } catch (error) {
              console.error('Claude API error:', error);
              core.setOutput('success', 'false');
              core.setOutput('error', error.message);
            }

      - name: Create Branch and Apply Changes
        if: steps.claude.outputs.success == 'true'
        id: create_branch
        run: |
          git config user.name "Claude Bot"
          git config user.email "claude-bot@users.noreply.github.com"

          BRANCH_NAME="claude/issue-${{ github.event.issue.number }}"
          git checkout -b $BRANCH_NAME

          echo "Branch created: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Parse and Apply Code Changes
        if: steps.claude.outputs.success == 'true'
        uses: actions/github-script@v7
        env:
          CLAUDE_RESPONSE: ${{ steps.claude.outputs.response }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const response = process.env.CLAUDE_RESPONSE;

            // Extract code blocks with file paths
            const regex = /```powershell\n#\s*([^\n]+)\n([\s\S]*?)```/g;
            let match;
            const files = [];

            while ((match = regex.exec(response)) !== null) {
              const filePath = match[1].trim();
              const code = match[2].trim();

              if (filePath && code && filePath.includes('/')) {
                files.push({ path: filePath, content: code });
              }
            }

            if (files.length > 0) {
              for (const file of files) {
                const dir = path.dirname(file.path);
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                fs.writeFileSync(file.path, file.content + '\n');
                console.log(`Created/Updated: ${file.path}`);
              }
              core.setOutput('files_changed', 'true');
              core.setOutput('file_count', files.length.toString());
            } else {
              console.log('No file changes detected in Claude response');
              core.setOutput('files_changed', 'false');
            }

      - name: Commit and Push Changes
        if: steps.claude.outputs.success == 'true'
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: Implement changes for issue #${{ github.event.issue.number }}

            Automated implementation by Claude AI in response to:
            ${{ github.event.issue.title }}

            ü§ñ Generated with Claude

            Co-Authored-By: Claude <claude@anthropic.com>"

            git push origin ${{ steps.create_branch.outputs.branch_name }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.claude.outputs.success == 'true'
        uses: actions/github-script@v7
        env:
          CLAUDE_RESPONSE: ${{ steps.claude.outputs.response }}
        with:
          script: |
            const branchName = `claude/issue-${{ github.event.issue.number }}`;

            // Check if branch has commits ahead of main
            try {
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: 'master',
                head: branchName
              });

              if (comparison.ahead_by === 0) {
                console.log('No commits ahead of master, skipping PR creation');
                return;
              }
            } catch (e) {
              console.log('Could not compare branches:', e.message);
            }

            // Create the PR
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Claude] ${context.payload.issue.title}`,
                body: `## Summary

            This PR was automatically generated by Claude in response to issue #${{ github.event.issue.number }}.

            ## Claude's Analysis

            ${process.env.CLAUDE_RESPONSE.substring(0, 2000)}...

            ## Related Issue

            Fixes #${{ github.event.issue.number }}

            ## Review Checklist

            - [ ] Code follows PSZoom patterns and conventions
            - [ ] Comment-based help is complete and accurate
            - [ ] Tests pass (if applicable)
            - [ ] Changes are appropriate for the request

            ---

            ü§ñ *This PR was automatically generated by Claude AI. Please review carefully before merging.*`,
                head: branchName,
                base: 'master'
              });

              // Add labels to the PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['claude-generated', 'needs-review']
              });

              // Comment on the original issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ I've created a pull request with my proposed changes: #${pr.number}\n\nPlease review the changes and let me know if you'd like any modifications!`
              });

              console.log(`Created PR #${pr.number}`);

            } catch (error) {
              console.error('Error creating PR:', error.message);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è I encountered an issue while creating the pull request: ${error.message}\n\nMy analysis and proposed changes are in branch \`${branchName}\`.`
              });
            }

      - name: Handle Failure
        if: steps.claude.outputs.success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå I encountered an error while processing your request. Please check that the ANTHROPIC_API_KEY secret is configured correctly.\n\nError: ${{ steps.claude.outputs.error || 'Unknown error' }}`
            });
