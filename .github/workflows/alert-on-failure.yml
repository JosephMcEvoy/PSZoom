name: Alert on Failure

on:
  workflow_run:
    workflows: ["API Coverage Sync", "Test"]
    types: [completed]

jobs:
  alert:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    permissions:
      issues: write

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const runUrl = context.payload.workflow_run.html_url;
            const branch = context.payload.workflow_run.head_branch;
            const sha = context.payload.workflow_run.head_sha.substring(0, 7);

            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
              per_page: 10
            });

            const issueTitle = `CI Failure: ${workflowName}`;
            const existingIssue = existingIssues.data.find(i => i.title === issueTitle);

            const body = `## Workflow Failure Alert

**Workflow:** ${workflowName}
**Branch:** ${branch}
**Commit:** ${sha}
**Run:** ${runUrl}

### Next Steps
1. Check the [workflow run](${runUrl}) for error details
2. Fix the failing tests or code
3. Close this issue when resolved

---
*This issue was automatically created by the alert-on-failure workflow.*`;

            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Failure\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: body,
                labels: ['ci-failure', 'automated']
              });
            }
