name: Publish PowerShell Module

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test validation before publishing'
        required: false
        default: 'false'
        type: boolean

jobs:
  validate:
    name: Validate Module
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -RequiredVersion 5.6.1 -Force -SkipPublisherCheck

      - name: Run Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration -Hashtable @{
            Run = @{ Path = './Tests'; Exit = $true }
            Output = @{ Verbosity = 'Detailed' }
          }
          Invoke-Pester -Configuration $config

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
          $results = Invoke-ScriptAnalyzer -Path ./PSZoom -Recurse -Severity Error
          if ($results) {
            $results | Format-Table -AutoSize
            throw "PSScriptAnalyzer found $($results.Count) error(s)"
          }
          Write-Host "PSScriptAnalyzer passed with no errors"

  publish-to-gallery:
    name: Publish to PowerShell Gallery
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path './PSZoom/PSZoom.psd1'
          Write-Host "Module: $($manifest.Name)"
          Write-Host "Version: $($manifest.Version)"
          Write-Host "Author: $($manifest.Author)"

      - name: Publish Module
        env:
          NUGETAPIKEY: ${{ secrets.NUGETAPIKEY }}
        shell: pwsh
        run: |
          Publish-Module -Path './PSZoom' -NuGetApiKey $env:NUGETAPIKEY -Verbose

      - name: Summary
        run: |
          echo "## Module Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PSZoom module published to PowerShell Gallery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ github.event.release.tag_name || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
