# AppVeyor CI configuration for PSZoom

environment:
  nugetapikey:
    secure: /wkBebPoOhfZSU+7O0z+jpst5N+PDX+iD02S3z37lkDYqZ6CHixD/4xCXElBpth1

# Use Windows Server with PowerShell 7
image: Visual Studio 2022

# Skip on updates to the readme
# We can force this by adding [skip ci] or [ci skip] anywhere in commit message
skip_commits:
  message: /updated readme.*|update readme.*s/

# Don't use AppVeyor's automatic build
build: false

# IMPORTANT: Disable automatic test discovery
# This prevents AppVeyor from reporting "Build success" after test failures
test: off

# Install dependencies (no PSDepend or BuildHelpers)
install:
  - pwsh: |
      Set-PSRepository PSGallery -InstallationPolicy Trusted
      Install-Module -Name psake -RequiredVersion 4.9.0 -Force -Scope CurrentUser
      Install-Module -Name PSDeploy -RequiredVersion 1.0.5 -Force -Scope CurrentUser
      Install-Module -Name Pester -RequiredVersion 5.6.1 -Force -Scope CurrentUser -SkipPublisherCheck

# Run the CI/CD pipeline using build_script (not test_script)
# Exit code from Start-Build.ps1 will determine build success/failure
build_script:
  - pwsh: |
      $ErrorActionPreference = 'Stop'
      & .\Build\Start-Build.ps1 -Task Deploy
      if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

# Only build these branches
branches:
  only:
    - master
    - main
    - develop
    - dev

# Artifacts to preserve
artifacts:
  - path: '**\TestResults*.xml'
    name: TestResults
  - path: 'Tests\testResults.xml'
    name: UnitTestResults
  - path: 'Tests\coverage.xml'
    name: CoverageReport